name: TWRP Recovery Builder

on:
  workflow_dispatch:
    inputs:
      MANIFEST_URL:
        description: 'MANIFEST_URL (use git@github.com:XXXXX for SSH)'
        required: true
        default: 'https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp'
      MANIFEST_BRANCH:
        description: 'MANIFEST_BRANCH'
        required: true
        default: 'twrp-12.1'
      DEVICE_TREE_URL:
        description: 'DEVICE_TREE_URL'
        required: true
        default: 'https://github.com/WUNELEZI1/android_device_zyb_tb8786p1_64_k510_wifi'
      DEVICE_TREE_BRANCH:
        description: 'DEVICE_TREE_BRANCH'
        required: true
        default: 'main'
      DEVICE_PATH:
        description: 'DEVICE_PATH'
        required: true
        default: 'device/zyb/tb8786p1_64_k510_wifi'
      COMMON_TREE_URL:
        description: 'COMMON_TREE_URL (if no common tree, leave blank)'
        required: false
      COMMON_PATH:
        description: 'COMMON_PATH (if no common tree, leave blank)'
        required: false
      DEVICE_NAME:
        description: 'DEVICE_NAME'
        required: true
        default: 'tb8786p1_64_k510_wifi'
      MAKEFILE_NAME:
        description: 'MAKEFILE_NAME'
        required: true
        default: 'omni_tb8786p1_64_k510_wifi'
      BUILD_TARGET:
        description: 'BUILD_TARGET'
        required: true
        default: 'vendor_boot'

jobs:
  build:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
    - name: Display Run Parameters
      run: |
        echo "::group::Build Configuration"
        echo "Manifest URL: ${{ github.event.inputs.MANIFEST_URL }}"
        echo "Manifest Branch: ${{ github.event.inputs.MANIFEST_BRANCH }}"
        echo "Device Tree URL: ${{ github.event.inputs.DEVICE_TREE_URL }}"
        echo "Device Tree Branch: ${{ github.event.inputs.DEVICE_TREE_BRANCH }}"
        echo "Device Path: ${{ github.event.inputs.DEVICE_PATH }}"
        echo "Device Name: ${{ github.event.inputs.DEVICE_NAME }}"
        echo "Makefile Name: ${{ github.event.inputs.MAKEFILE_NAME }}"
        echo "Build Target: ${{ github.event.inputs.BUILD_TARGET }}.img"
        echo "::endgroup::"

    - name: Check Out
      uses: actions/checkout@v4

    - name: Cleanup
      uses: rokibhasansagar/slimhub_actions@main

    - name: Setup Disk Space
      run: |
        sudo fallocate -l 12G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        echo "/swapfile swap swap defaults 0 0" | sudo tee -a /etc/fstab
        sudo apt clean
        sudo rm -rf /var/lib/apt/lists/*

    - name: Prepare the environment
      run: |
        sudo apt update
        DEBIAN_FRONTEND=noninteractive sudo apt install -yq \
            linux-modules-extra-$(uname -r) \
            gperf gcc-multilib gcc-10-multilib g++-multilib g++-10-multilib \
            libc6-dev lib32ncurses-dev x11proto-core-dev libx11-dev tree lib32z-dev libgl1-mesa-dev libxml2-utils \
            xsltproc bc ccache lib32readline-dev lib32z1-dev liblz4-tool libncurses-dev libsdl1.2-dev \
            build-essential libgtk-3-dev libglu1-mesa-dev freeglut3-dev git libxml2 lzop pngcrush schedtool squashfs-tools \
            imagemagick libbz2-dev lzma ncftp qemu-user-static libstdc++-10-dev libncurses6 python3 tar

    - name: Install OpenJDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '11'

    - name: Setup SSH Keys
      if: startsWith(github.event.inputs.MANIFEST_URL, 'git@github.com') || 
          startsWith(github.event.inputs.DEVICE_TREE_URL, 'git@github.com') ||
          startsWith(github.event.inputs.COMMON_TREE_URL, 'git@github.com')
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Install repo
      run: |
        mkdir ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        sudo ln -sf ~/bin/repo /usr/bin/repo

    - name: Initialize repo
      run: |
        mkdir workspace
        cd workspace
        echo "workspace-folder=$(pwd)" >> $GITHUB_OUTPUT
        git config --global user.name "Nico170420"
        git config --global user.email "b170420nc@gmail.com"
        repo init --depth=1 -u ${{ github.event.inputs.MANIFEST_URL }} -b ${{ github.event.inputs.MANIFEST_BRANCH }}
      id: pwd

    - name: Repo Sync
      run: |
        echo "Checking disk space before sync:"
        df -h
        repo sync -j4 --force-sync --no-clone-bundle --optimized-fetch
        echo "Checking disk space after sync:"
        df -h
      working-directory: workspace

    - name: Clone and Build
      run: |
        echo "=== TWRP Recovery Builder ==="
        echo "Device: ${{ github.event.inputs.DEVICE_NAME }}"
        echo "Build Target: ${{ github.event.inputs.BUILD_TARGET }}.img"
        echo "======================================"
        
        echo ""
        echo "=== Step 1: Clone Device Tree ==="
        echo "Cloning from: ${{ github.event.inputs.DEVICE_TREE_URL }}"
        echo "Branch: ${{ github.event.inputs.DEVICE_TREE_BRANCH }}"
        echo "Path: ${{ github.event.inputs.DEVICE_PATH }}"
        
        git clone ${{ github.event.inputs.DEVICE_TREE_URL }} -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} ./${{ github.event.inputs.DEVICE_PATH }}
        
        if [ $? -eq 0 ]; then
          echo "Device tree cloned successfully"
          echo "Device tree contents:"
          ls -la ./${{ github.event.inputs.DEVICE_PATH }}/
        else
          echo "Failed to clone device tree"
          exit 1
        fi
        
        if [ -n "${{ github.event.inputs.COMMON_TREE_URL }}" ] && [ -n "${{ github.event.inputs.COMMON_PATH }}" ]; then
          echo ""
          echo "=== Clone Common Tree ==="
          git clone ${{ github.event.inputs.COMMON_TREE_URL }} -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} ./${{ github.event.inputs.COMMON_PATH }}
        fi
        
        echo ""
        echo "=== Step 2: Sync Device Dependencies ==="
        if [ -f "${{ github.event.inputs.DEVICE_PATH }}/twrp.dependencies" ]; then
          echo "Found TWRP dependencies"
          if [ -f "${GITHUB_WORKSPACE}/scripts/convert.sh" ]; then
            bash ${GITHUB_WORKSPACE}/scripts/convert.sh ${{ github.event.inputs.DEVICE_PATH }}/twrp.dependencies
            repo sync -j4
          fi
        elif [ -f "${{ github.event.inputs.DEVICE_PATH }}/omni.dependencies" ]; then
          echo "Found Omni dependencies"
          if [ -f "${GITHUB_WORKSPACE}/scripts/convert.sh" ]; then
            bash ${GITHUB_WORKSPACE}/scripts/convert.sh ${{ github.event.inputs.DEVICE_PATH }}/omni.dependencies
            repo sync -j4
          fi
        fi
        
        echo ""
        echo "=== Step 3: Initialize Build Environment ==="
        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        echo "Build environment initialized"
        
        echo ""
        echo "=== Step 4: Select Build Target ==="
        echo "Selecting target for ${{ github.event.inputs.DEVICE_NAME }}"
        
        if breakfast twrp_${{ github.event.inputs.DEVICE_NAME }}-eng; then
          echo "Selected: breakfast twrp_${{ github.event.inputs.DEVICE_NAME }}-eng"
        elif lunch ${{ github.event.inputs.MAKEFILE_NAME }}-eng; then
          echo "Selected: lunch ${{ github.event.inputs.MAKEFILE_NAME }}-eng"
        else
          echo "Failed to select build target"
          echo "Available lunch targets:"
          lunch
          exit 1
        fi
        
        echo ""
        echo "=== Step 5: Build Recovery Image ==="
        echo "Building: ${{ github.event.inputs.BUILD_TARGET }}.img"
        echo "Starting build at: $(date)"
        
        BUILD_START=$(date +%s)
        make clean
        mka ${{ github.event.inputs.BUILD_TARGET }}
        BUILD_END=$(date +%s)
        BUILD_TIME=$((BUILD_END - BUILD_START))
        
        echo ""
        echo "=== Build Summary ==="
        echo "Build completed at: $(date)"
        echo "Total build time: ${BUILD_TIME} seconds"
        echo "Device: ${{ github.event.inputs.DEVICE_NAME }}"
        echo "Target: ${{ github.event.inputs.BUILD_TARGET }}.img"
      working-directory: ${{ steps.pwd.outputs.workspace-folder }}

    - name: Verify Build Output
      run: |
        OUTPUT_PATH="out/target/product/${{ github.event.inputs.DEVICE_NAME }}"
        echo "Checking build output in $OUTPUT_PATH"
        
        if [ -d "$OUTPUT_PATH" ]; then
          echo "Contents of $OUTPUT_PATH:"
          ls -la "$OUTPUT_PATH/"
          
          TARGET_FILE="$OUTPUT_PATH/${{ github.event.inputs.BUILD_TARGET }}.img"
          if [ -f "$TARGET_FILE" ]; then
            echo "SUCCESS: ${{ github.event.inputs.BUILD_TARGET }}.img created"
            echo "File size: $(ls -lh "$TARGET_FILE" | awk '{print $5}')"
          else
            echo "WARNING: Target file not found"
            echo "Available image files:"
            find "$OUTPUT_PATH" -name "*.img" -type f
          fi
        else
          echo "ERROR: Output directory not found"
        fi
      working-directory: ${{ steps.pwd.outputs.workspace-folder }}

    - name: Prepare Release Files
      run: |
        OUTPUT_PATH="out/target/product/${{ github.event.inputs.DEVICE_NAME }}"
        
        if [ -d "$OUTPUT_PATH" ]; then
          echo "Preparing release files..."
          
          BUILD_INFO_FILE="$OUTPUT_PATH/build_info.txt"
          echo "TWRP Recovery Build" > "$BUILD_INFO_FILE"
          echo "===================" >> "$BUILD_INFO_FILE"
          echo "Device: ${{ github.event.inputs.DEVICE_NAME }}" >> "$BUILD_INFO_FILE"
          echo "Manifest: ${{ github.event.inputs.MANIFEST_BRANCH }}" >> "$BUILD_INFO_FILE"
          echo "Build Target: ${{ github.event.inputs.BUILD_TARGET }}.img" >> "$BUILD_INFO_FILE"
          echo "Build ID: ${{ github.run_id }}" >> "$BUILD_INFO_FILE"
          echo "Date: $(date)" >> "$BUILD_INFO_FILE"
          echo "Device Tree: ${{ github.event.inputs.DEVICE_TREE_URL }}" >> "$BUILD_INFO_FILE"
          
          echo "Build info saved to $BUILD_INFO_FILE"
          echo "Release files ready"
        fi
      working-directory: ${{ steps.pwd.outputs.workspace-folder }}

    - name: Upload to Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/${{ github.event.inputs.BUILD_TARGET }}.img
          workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/build_info.txt
          workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.zip
          workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*vendor*.img
        name: ${{ github.event.inputs.DEVICE_NAME }}-${{ github.run_id }}
        tag_name: ${{ github.run_id }}
        body: |
          TWRP Recovery Build for ${{ github.event.inputs.DEVICE_NAME }}
          
          Manifest: ${{ github.event.inputs.MANIFEST_BRANCH }}
          Device: ${{ github.event.inputs.DEVICE_NAME }}
          Target: ${{ github.event.inputs.BUILD_TARGET }}.img
          Build ID: ${{ github.run_id }}
          
          Device Tree: ${{ github.event.inputs.DEVICE_TREE_URL }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
